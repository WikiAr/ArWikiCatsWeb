# Architecture

> **Relevant source files**
> * [README.md](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/README.md)
> * [service.template](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/service.template)
> * [src/app.py](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/src/app.py)

## Purpose and Scope

This document explains the overall architectural structure of ArWikiCatsWeb, including the application factory pattern, component organization, and request flow patterns. It provides a high-level view of how the system's modules interact and how requests are processed through different layers.

For detailed information about specific components:

* Application initialization and WSGI entry points: see [Application Core](/ArWikiCats/ArWikiCatsWeb/3.1-application-core)
* Blueprint registration and route organization: see [Routing and Blueprints](/ArWikiCats/ArWikiCatsWeb/3.2-routing-and-blueprints)
* REST API implementation details: see [REST API](/ArWikiCats/ArWikiCatsWeb/4-rest-api)
* Web interface implementation: see [Web Interface](/ArWikiCats/ArWikiCatsWeb/5-web-interface)
* Database operations: see [Database Layer](/ArWikiCats/ArWikiCatsWeb/7-database-layer)

## Layered Architecture

ArWikiCatsWeb follows a layered architecture pattern that separates concerns into distinct tiers. The application is structured as a Flask web application with clear boundaries between presentation, business logic, and data access layers.

```mermaid
flowchart TD

app_py["app.py<br>WSGI Entry Point"]
app1_py["app1.py<br>Development Entry Point"]
create_app["create_app()<br>app/init.py"]
api_routes["API Blueprint<br>app/routes/api.py"]
ui_routes["UI Blueprint<br>app/routes/ui.py"]
logs_bot["logs_bot module<br>app/logs_bot.py"]
arwikicats["ArWikiCats library<br>External dependency"]
logs_db_bot["logs_db.bot<br>app/logs_db/bot.py"]
logs_db_core["logs_db.db<br>app/logs_db/db.py"]
sqlite_db["api_logs.db<br>SQLite Database"]
templates["Jinja2 Templates<br>templates/*.html"]
static["Static Assets<br>static/js/*.js<br>static/css/*.css"]

app_py --> create_app
app1_py --> create_app
create_app --> api_routes
create_app --> ui_routes
api_routes --> logs_bot
api_routes --> arwikicats
ui_routes --> logs_bot
ui_routes --> templates
logs_bot --> logs_db_bot
api_routes --> logs_db_bot
logs_db_core --> sqlite_db

subgraph subGraph6 ["Presentation Layer"]
    templates
    static
    templates --> static
end

subgraph Storage ["Storage"]
    sqlite_db
end

subgraph subGraph4 ["Data Access Layer"]
    logs_db_bot
    logs_db_core
    logs_db_bot --> logs_db_core
end

subgraph subGraph3 ["Business Logic Layer"]
    logs_bot
    arwikicats
end

subgraph subGraph2 ["Routing Layer"]
    api_routes
    ui_routes
end

subgraph subGraph1 ["Application Factory"]
    create_app
end

subgraph subGraph0 ["Entry Points"]
    app_py
    app1_py
end
```

**Sources:** [src/app.py L1-L16](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/src/app.py#L1-L16)

 [src/app/__init__.py](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/src/app/__init__.py)

 [src/app/routes/api.py](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/src/app/routes/api.py)

 [src/app/routes/ui.py](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/src/app/routes/ui.py)

 [src/app/logs_bot.py](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/src/app/logs_bot.py)

 [src/app/logs_db/bot.py](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/src/app/logs_db/bot.py)

 [src/app/logs_db/db.py](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/src/app/logs_db/db.py)

 [README.md L74-L108](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/README.md#L74-L108)

## Application Factory Pattern

The application uses the **factory pattern** through the `create_app()` function located in [src/app/__init__.py](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/src/app/__init__.py)

 This pattern provides several architectural benefits:

| Benefit | Description |
| --- | --- |
| **Testability** | Enables creating multiple application instances with different configurations for testing |
| **Modularity** | Centralizes application initialization and configuration |
| **Flexibility** | Supports different configurations for development, testing, and production |

### Entry Points

The application has two distinct entry points:

1. **Production Entry Point**: [src/app.py L1-L16](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/src/app.py#L1-L16) * WSGI-compatible entry point for production deployment * Imports `create_app()` from the `app` package * Initializes the database via `init_db()` when run directly * Creates the Flask application instance as `app` variable for UWSGI
2. **Development Entry Point**: `src/app1.py` * Alternative entry point for local development * Similar structure to `app.py` but may have different debug settings

```mermaid
flowchart TD

uwsgi["UWSGI Server"]
app_py["app.py"]
create_app_prod["create_app()"]
flask_app_prod["Flask App Instance"]
developer["Developer"]
app1_py["app1.py"]
create_app_dev["create_app()"]
flask_app_dev["Flask App Instance"]
debug_server["Flask Debug Server"]
init_db["init_db()<br>logs_db/init.py"]

app_py --> init_db
app1_py --> init_db

subgraph Initialization ["Initialization"]
    init_db
end

subgraph subGraph1 ["Development Flow"]
    developer
    app1_py
    create_app_dev
    flask_app_dev
    debug_server
    developer --> app1_py
    app1_py --> create_app_dev
    create_app_dev --> flask_app_dev
    flask_app_dev --> debug_server
end

subgraph subGraph0 ["Production Flow"]
    uwsgi
    app_py
    create_app_prod
    flask_app_prod
    uwsgi --> app_py
    app_py --> create_app_prod
    create_app_prod --> flask_app_prod
end
```

**Sources:** [src/app.py L1-L16](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/src/app.py#L1-L16)

 [README.md L45-L55](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/README.md#L45-L55)

## Component Organization

The codebase follows a modular structure with clear separation between different functional areas:

### Directory Structure

| Directory/Module | Purpose | Key Components |
| --- | --- | --- |
| `src/app/` | Application package root | `__init__.py` (factory function) |
| `src/app/routes/` | Request routing layer | `api.py`, `ui.py` |
| `src/app/logs_db/` | Data access layer | `bot.py`, `db.py` |
| `src/app/logs_bot.py` | Business logic for log retrieval | Query functions, status processing |
| `src/templates/` | Presentation layer | Jinja2 HTML templates |
| `src/static/` | Client-side assets | JavaScript modules, CSS files |
| `tests/` | Test suite | Unit and integration tests |

```mermaid
flowchart TD

bot["bot.py<br>log_request()<br>fetch_all()"]
init["init.py<br>create_app()"]
api["api.py<br>API endpoints"]
ui["ui.py<br>UI routes"]
logs_bot["logs_bot.py<br>view_logs()<br>retrieve_logs_by_date()<br>retrieve_logs_en_to_ar()<br>get_response_status()"]
db["db.py<br>db_commit()<br>init_db()"]

subgraph subGraph2 ["src/app/ Package"]
    init
    logs_bot
    init --> api
    init --> ui
    api --> logs_bot
    ui --> logs_bot
    api --> bot
    logs_bot --> bot

subgraph logs_db/ ["logs_db/"]
    bot
    db
    bot --> db
end

subgraph routes/ ["routes/"]
    api
    ui
end
end
```

**Sources:** [README.md L74-L108](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/README.md#L74-L108)

## Request Processing Flow

The application handles two distinct types of requests with different processing patterns:

### API Request Flow

API requests are processed through the `api.py` blueprint with validation, business logic, and logging:

```mermaid
flowchart TD

client["API Client"]
validate["User-Agent Validation<br>api.py"]
resolve["Category Resolution<br>ArWikiCats.getlabel()"]
query["Log Query<br>logs_bot functions"]
log["Request Logging<br>log_request()"]
response["JSON Response"]

client --> validate
validate --> resolve
validate --> query
resolve --> log
query --> log
log --> response
response --> client
```

**Key Functions:**

* User-Agent validation in [src/app/routes/api.py](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/src/app/routes/api.py)
* Category resolution via `ArWikiCats.getlabel()` method
* Request logging via `log_request()` in [src/app/logs_db/bot.py](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/src/app/logs_db/bot.py)

### UI Request Flow

UI requests are processed through the `ui.py` blueprint, rendering server-side templates that load client-side JavaScript for API interaction:

```mermaid
flowchart TD

browser["Web Browser"]
ui_route["UI Route Handler<br>ui.py"]
query_logs["Query Logs<br>logs_bot module"]
render["Render Template<br>Jinja2"]
html["HTML Response<br>+ embedded data"]
js["Client-Side JS<br>api.js, api_list.js"]
api_call["API Request"]
api_route["API Routes"]

browser --> ui_route
ui_route --> query_logs
ui_route --> render
render --> html
html --> browser
browser --> js
js --> api_call
api_call --> api_route
```

**Sources:** [src/app/routes/api.py](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/src/app/routes/api.py)

 [src/app/routes/ui.py](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/src/app/routes/ui.py)

 Diagram 2 from high-level architecture

## Key Architectural Patterns

### Blueprint Pattern

The application uses Flask's **Blueprint** pattern to organize routes into logical modules:

| Blueprint | Purpose | Registration |
| --- | --- | --- |
| `api_blueprint` | REST API endpoints | Registered with `/api` prefix |
| `ui_blueprint` | Web interface routes | Registered at root path `/` |

Each blueprint is self-contained and registered with the application factory during initialization.

**Sources:** [src/app/routes/api.py](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/src/app/routes/api.py)

 [src/app/routes/ui.py](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/src/app/routes/ui.py)

 [README.md L110-L176](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/README.md#L110-L176)

### Separation of Concerns

The architecture enforces strict separation between layers:

1. **Routing Layer** (`routes/`): Handles HTTP requests/responses, validation, error handling
2. **Business Logic Layer** (`logs_bot.py`): Implements domain logic for log processing and analysis
3. **Data Access Layer** (`logs_db/`): Abstracts database operations with two-tier structure: * `bot.py`: High-level operations (`log_request`, `fetch_all`) * `db.py`: Low-level database primitives (`db_commit`, `init_db`)

### Hybrid Rendering Strategy

The application employs a **hybrid server-side and client-side rendering** approach:

* Server-side: Jinja2 templates render initial page structure and static content
* Client-side: JavaScript modules (`api.js`, `api_list.js`, `x.js`) fetch dynamic data via AJAX

This pattern optimizes for both initial page load performance and interactive user experience.

```mermaid
flowchart TD

ui_route["UI Route"]
template["Jinja2 Template"]
html["HTML with placeholders"]
browser["Browser"]
js_load["Load JS modules"]
api_request["Fetch API"]
api_endpoint["API Endpoint"]
json["JSON Response"]
dom_update["Update DOM"]

html --> browser

subgraph subGraph1 ["Client-Side Processing"]
    browser
    js_load
    api_request
    api_endpoint
    json
    dom_update
    browser --> js_load
    js_load --> api_request
    api_request --> api_endpoint
    api_endpoint --> json
    json --> dom_update
end

subgraph subGraph0 ["Server-Side Rendering"]
    ui_route
    template
    html
    ui_route --> template
    template --> html
end
```

**Sources:** [src/templates/](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/src/templates/)

 [src/static/js/](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/src/static/js/)

 Diagram 5 from high-level architecture

## Configuration and Deployment Architecture

The application is configured for deployment on **Wikimedia Toolforge** using Kubernetes:

| Configuration | Value | File |
| --- | --- | --- |
| Backend | Kubernetes | [service.template L7](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/service.template#L7-L7) |
| Python Version | 3.11 | [service.template L20](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/service.template#L20-L20) |
| CPU Allocation | 3 cores | [service.template L10](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/service.template#L10-L10) |
| Memory | 6Gi | [service.template L13](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/service.template#L13-L13) |
| Replicas | 2 | [service.template L16](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/service.template#L16-L16) |

The high-availability setup with 2 replicas ensures continuous service even during pod restarts or updates.

**Sources:** [service.template L1-L27](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/service.template#L1-L27)

 [README.md L196-L215](https://github.com/ArWikiCats/ArWikiCatsWeb/blob/88f42d13/README.md#L196-L215)

## Summary

ArWikiCatsWeb implements a well-structured Flask application with:

* **Factory Pattern**: Centralized application initialization via `create_app()`
* **Layered Architecture**: Clear separation between routing, business logic, and data access
* **Blueprint Organization**: Modular route handlers for API and UI
* **Dual Entry Points**: Separate configurations for production (UWSGI) and development
* **Hybrid Rendering**: Server-side templates with client-side dynamic updates
* **High Availability**: Kubernetes deployment with 2 replicas

This architecture supports both programmatic access via REST API and human interaction via web interface, while maintaining comprehensive logging for observability and analytics.